"""
Module Vue d'Ensemble Planning - Dashboard d'actions prioritaires

Affiche les actions critiques et sugg√®re automatiquement ce qui doit √™tre fait
Utilise PlanningAIService pour d√©tection intelligente des alertes
"""

from datetime import date, datetime, timedelta

import streamlit as st

from src.services.planning_unified import get_planning_unified_service

# Logique m√©tier pure
from src.domains.planning.logic.vue_ensemble_logic import (
    analyser_charge_globale,
    identifier_taches_urgentes
)
from src.core.state import get_state

logger = __import__("logging").getLogger(__name__)


# √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢
# HELPERS UI
# √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢


def afficher_actions_prioritaires(alertes_semaine: list) -> None:
    """Affiche les actions prioritaires en tableau"""
    if not alertes_semaine:
        st.success("‚úÖ Semaine bien √©quilibr√©e - Aucune action urgente")
        return

    st.markdown("### üéØ Actions √† Prendre")

    for alerte in alertes_semaine:
        # Parser l'alerte pour extraire emoji et message
        parts = alerte.split(" - ") if " - " in alerte else [alerte]
        emoji = parts[0] if len(parts) > 1 else "‚ö†Ô∏è"
        message = parts[-1]

        col_msg, col_action = st.columns([3, 1])

        with col_msg:
            st.warning(message, icon=emoji)

        with col_action:
            if "üéØ" in emoji:
                if st.button("‚Üí Activit√©s", key=f"alerte_{alerte[:20]}", use_container_width=True):
                    st.session_state.planning_view = "activites"

            elif "üçΩÔ∏è" in emoji:
                if st.button("√¢‚Ä†‚Äô Budget", key=f"alerte_{alerte[:20]}", use_container_width=True):
                    st.session_state.planning_view = "budget"

            elif "√¢≈°¬†√Ø¬∏" in emoji:
                if st.button("√¢‚Ä†‚Äô Voir", key=f"alerte_{alerte[:20]}", use_container_width=True):
                    pass


def afficher_metriques_cles(stats: dict, charge_globale: str) -> None:
    """Affiche les KPIs principaux"""
    st.markdown("### üìä M√©triques Cl√©s")

    col_m1, col_m2, col_m3, col_m4, col_m5 = st.columns(5)

    with col_m1:
        st.metric("üßπ Repas", stats.get("total_repas", 0))

    with col_m2:
        st.metric("üé® Activit√©s", stats.get("total_activites", 0))

    with col_m3:
        st.metric("üí° Pour Jules", stats.get("activites_jules", 0))

    with col_m4:
        st.metric("üí∞ Projets", stats.get("total_projets", 0))

    with col_m5:
        budget = stats.get("budget_total", 0)
        st.metric("üçΩÔ∏è Budget", f"{budget:.0f}‚Ç¨")

    st.markdown("---")

    # Charge globale
    charge_emoji = {
        "faible": "üöÄ",
        "normal": "üë∂",
        "intense": "‚ùå",
    }.get(charge_globale, "‚ö´")

    st.markdown(f"### {charge_emoji} Charge Globale: **{charge_globale.upper()}**")

    charge_score = stats.get("charge_moyenne", 50)
    st.progress(min(charge_score / 100, 1.0))

    if charge_score >= 80:
        st.warning("‚ö†Ô∏è Charge familiale tr√®s √©lev√©e - √Ä prendre en compte pour le bien-√™tre")
    elif charge_score >= 70:
        st.info("‚ÑπÔ∏è Charge normale - Veiller au repos et temps de qualit√©")
    else:
        st.success("‚úÖ Charge faible - Bonne semaine √©quilibr√©e")


def afficher_synthese_jours(jours: dict) -> None:
    """Affiche synth√®se visuelle des jours"""
    st.markdown("### üì± Synth√®se par jour")

    jours_noms = ["lun", "mar", "mer", "jeu", "ven", "sam", "dim"]
    jours_list = list(jours.values())

    cols = st.columns(7)

    for i, col in enumerate(cols):
        with col:
            jour = jours_list[i]
            jour_nom = jours_noms[i]

            # Badge avec charge
            charge_emoji = {
                "faible": "üöÄ",
                "normal": "üë∂",
                "intense": "‚ùå",
            }.get(jour.charge, "‚ö´")

            st.markdown(
                f"""
                <div style="text-align: center; padding: 10px; border-radius: 8px; background: #f0f2f6;">
                    <h4>{charge_emoji}</h4>
                    <p style="margin: 5px 0; font-size: 12px;"><strong>{jour_nom.upper()}</strong></p>
                    <p style="margin: 5px 0; font-size: 11px;">{jour.charge_score}/100</p>
                    <p style="margin: 5px 0; font-size: 11px;">
                        üßπ{len(jour.repas)} üé®{len(jour.activites)}
                    </p>
                </div>
                """,
                unsafe_allow_html=True,
            )


def afficher_opportunities(semaine_data: dict) -> None:
    """Sugg√®re automatiquement des am√©liorations"""
    st.markdown("### üóëÔ∏è Suggestions d'Am√©lioration")

    suggestions = []

    # Jules: activit√©s
    activites_jules = semaine_data.get("activites_jules", 0)
    if activites_jules == 0:
        suggestions.append(
            ("üí° Aucune activit√© pour Jules", 
             "Planifier au moins 2-3 activit√©s adapt√©es √† 19m par semaine")
        )
    elif activites_jules < 2:
        suggestions.append(
            ("üí° Peu d'activit√©s pour Jules",
             f"Actuellement {activites_jules} - Recommand√©: 3+")
        )

    # Budget
    budget_total = semaine_data.get("budget_total", 0)
    budget_limite = 500  # √Ä adapter √† votre budget
    if budget_total > budget_limite:
        suggestions.append(
            ("üçΩÔ∏è Budget elev√©",
             f"{budget_total:.0f}‚Ç¨ > {budget_limite}‚Ç¨ - Revoir les d√©penses")
        )

    # Pas de repas
    if semaine_data.get("total_repas", 0) == 0:
        suggestions.append(
            ("üßπ Aucun repas planifi√©",
             "Pr√©voir le planning culinaire de la semaine")
        )

    if suggestions:
        for emoji_title, description in suggestions:
            with st.container():
                col1, col2 = st.columns([1, 4])
                with col1:
                    st.write("üóëÔ∏è")
                with col2:
                    st.write(f"**{emoji_title}**: {description}")
    else:
        st.success("‚úÖ Semaine bien √©quilibr√©e - Aucune suggestion")


# √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢
# MODULE PRINCIPAL
# √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢


def app():
    """Module Vue d'Ensemble - Actions prioritaires"""

    st.title("üéØ Vue d'Ensemble Planning")
    st.caption("Actions prioritaires et suggestions intelligentes pour la semaine")

    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢
    # NAVIGATION SEMAINE
    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢

    if "ensemble_week_start" not in st.session_state:
        today = date.today()
        st.session_state.ensemble_week_start = today - timedelta(days=today.weekday())

    col_nav1, col_nav2, col_nav3 = st.columns([1, 2, 1])

    with col_nav1:
        if st.button("√¢¬¨‚Ä¶√Ø¬∏ Semaine pr√©c√©dente", key="prev_ensemble"):
            st.session_state.ensemble_week_start -= timedelta(days=7)
            st.rerun()

    with col_nav2:
        week_start = st.session_state.ensemble_week_start
        week_end = week_start + timedelta(days=6)
        st.markdown(
            f"<h3 style='text-align: center;'>{week_start.strftime('%d/%m')} √¢‚Ç¨‚Äù {week_end.strftime('%d/%m/%Y')}</h3>",
            unsafe_allow_html=True,
        )

    with col_nav3:
        if st.button("Semaine suivante √¢≈æ¬°√Ø¬∏", key="next_ensemble"):
            st.session_state.ensemble_week_start += timedelta(days=7)
            st.rerun()

    st.markdown("---")

    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢
    # CHARGEMENT DONN√âES
    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢

    service = get_planning_unified_service()
    semaine = service.get_semaine_complete(st.session_state.ensemble_week_start)

    if not semaine:
        st.error("‚ùå Erreur lors du chargement de la semaine")
        return

    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢
    # ACTIONS PRIORITAIRES (TOP)
    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢

    if semaine.alertes_semaine:
        st.markdown("### üì∑ Actions Critiques")
        afficher_actions_prioritaires(semaine.alertes_semaine)
        st.markdown("---")

    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢
    # M√âTRIQUES CL√âS
    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢

    afficher_metriques_cles(semaine.stats_semaine, semaine.charge_globale)

    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢
    # SYNTH√ÉÀÜSE JOURS
    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢

    afficher_synthese_jours(semaine.jours)

    st.markdown("---")

    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢
    # SUGGESTIONS & OPPORTUNITIES
    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢

    afficher_opportunities(semaine.stats_semaine)

    st.markdown("---")

    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢
    # ONGLETS D√âTAILS
    # √¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢√¢‚Ä¢

    tab1, tab2, tab3 = st.tabs(["üîÑ R√©√©quilibrer", "ü§ñ Optimiser avec IA", "üìÖ D√©tails"])

    with tab1:
        st.subheader("üîÑ R√©√©quilibrer la semaine")

        st.info(
            "üóëÔ∏è Les jours tr√®s charg√©s peuvent √™tre r√©√©quilibr√©s en d√©pla√ßant certaines activit√©s"
        )

        # Identifier jours charg√©s
        jours_list = list(semaine.jours.values())
        jours_charges = [
            (i, j) for i, j in enumerate(jours_list) if j.charge_score >= 75
        ]

        if jours_charges:
            for idx, jour_charge in jours_charges[:2]:
                jour_names = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"]
                jour_nom = jour_names[idx]

                with st.expander(f"‚ùå {jour_nom} - Surcharg√© ({jour_charge.charge_score}/100)"):
                    st.write(f"Activit√©s: {len(jour_charge.activites)} | Repas: {len(jour_charge.repas)}")

                    if st.button(f"Proposer r√©partition", key=f"reequilibrer_{idx}"):
                        st.info("üóëÔ∏è Suggestion: D√©placer 1-2 activit√©s vers jour plus calme")

        else:
            st.success("‚úÖ Semaine bien √©quilibr√©e - Aucun r√©√©quilibrage n√©cessaire")

    with tab2:
        st.subheader("ü§ñ Optimiser avec IA")

        st.info("L'IA peut g√©n√©rer une semaine optimale bas√©e sur vos contraintes")

        with st.form("form_optimize"):
            col_o1, col_o2 = st.columns(2)

            with col_o1:
                budget = st.number_input("Budget semaine (‚Ç¨)", 100, 1000, 400)
                energie = st.selectbox("√ânergie famille", ["faible", "normal", "√©lev√©e"])

            with col_o2:
                objectifs = st.multiselect(
                    "Objectifs sant√©",
                    ["Cardio", "Yoga", "D√©tente", "Temps famille", "Sommeil"],
                )
                priorites = st.multiselect(
                    "Priorit√©s",
                    ["Activit√©s Jules", "Repos", "Projets", "Social"],
                    default=["Activit√©s Jules"],
                )

            submitted = st.form_submit_button("üîî G√©n√©rer optimisation", type="primary")

            if submitted:
                with st.spinner("ü§ñ L'IA analyse..."):
                    result = service.generer_semaine_ia(
                        date_debut=st.session_state.ensemble_week_start,
                        contraintes={
                            "budget": budget,
                            "energie": energie,
                        },
                        contexte={
                            "objectifs_sante": objectifs,
                            "priorites": priorites,
                            "jules_age_mois": 19,
                        },
                    )

                    if result:
                        st.success("‚úÖ Optimisation g√©n√©r√©e!")
                        st.markdown(f"**Philosophie**: {result.harmonie_description}")

                        with st.expander("Pourquoi cette approche?"):
                            for raison in result.raisons:
                                st.write(f"‚Ä¢ {raison}")

                        st.info("üóëÔ∏è Vous pouvez cr√©er ces √©l√©ments dans votre planning")
                    else:
                        st.error("‚ùå Erreur g√©n√©ration")

    with tab3:
        st.subheader("üìÖ D√©tails Semaine")

        jours_semaine = ["lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi", "dimanche"]

        selected_jour = st.selectbox("S√©lectionner un jour", jours_semaine, key="ensemble_jour_select")

        jour_idx = jours_semaine.index(selected_jour)
        jour_date = st.session_state.ensemble_week_start + timedelta(days=jour_idx)
        jour_str = jour_date.isoformat()

        jour_data = semaine.jours.get(jour_str)

        if jour_data:
            jour_data_dict = jour_data.dict()

            st.markdown(f"### {selected_jour.capitalize()} {jour_date.strftime('%d/%m')}")

            col_d1, col_d2, col_d3 = st.columns(3)

            with col_d1:
                charge_emoji = {
                    "faible": "üöÄ",
                    "normal": "üë∂",
                    "intense": "‚ùå",
                }.get(jour_data_dict["charge"], "‚ö´")
                st.metric("Charge", f"{charge_emoji} {jour_data_dict['charge_score']}/100")

            with col_d2:
                st.metric("√âv√©nements", len(jour_data_dict["repas"]) + len(jour_data_dict["activites"]))

            with col_d3:
                st.metric("Budget", f"{jour_data_dict['budget_jour']:.0f}‚Ç¨")

            st.write(f"**Repas**: {len(jour_data_dict['repas'])}")
            st.write(f"**Activit√©s**: {len(jour_data_dict['activites'])}")
            st.write(f"**Projets**: {len(jour_data_dict['projets'])}")

            if jour_data_dict.get("alertes"):
                st.warning("**Alertes du jour**:")
                for alerte in jour_data_dict["alertes"]:
                    st.write(f"‚Ä¢ {alerte}")

